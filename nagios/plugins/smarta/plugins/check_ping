#! lua

-- check ping

-- author: ery.lee@gmail.com from nodehub.cn

require("plugin")

-- do check
function check(opts) 
  local status = STATUS_OK
  local host = opts["H"]
  local packets = opts["t"]
  local timeout = opts["t"]
  uname = os.uname()
  if uname == "Darwin" then
    cmd = "ping".." -c "..packets.." -t "..timeout.." "..host 
  elseif uname == "HP-UX" then
    cmd = "ping "..host.." -n 4 -m 8"
  elseif uname == "SunOS" then
    cmd = "ping -s -n "..host.." 56 4"; 
  elseif uname == "AIX" then
    cmd = "ping -c 4 -w 8 "..host
  else
    -- linux default
    cmd = "ping".." -c "..packets.." -w "..timeout.." "..host
  end
  output = os.cmd(cmd)
  pl = string.match(output, "%s(%d+)%% packet loss")
  if not pl then
    print("UNKNOWN - ping error\n")
    print(output)
    return STATUS_UNKNOWN
  end
  if pl == "100" then
    print("CRITICAL - packet loss = "..pl.."%\n")
    return STATUS_CRITICAL
  end
  rtmin,rta,rtmax=string.match(output, "([0-9]+.[0-9]+)/([0-9]+.[0-9]+)/([0-9]+.[0-9]+)/([0-9]+.[0-9]+) ms")
  if pl == "0" then
	status = STATUS_OK
    print(string.format("OK - 丢包率: %s%%, 平均往返时延: %sms",  pl, rta))
  else
	status = STATUS_WARNING
    print(string.format("WARNING - 丢包率: %s%%, 平均往返时延: %sms",  pl, rta))
  end
  print("graph:pl(%)")
  print("metric:pl: "..pl.."%")
  print("metric:rta: "..rta.."ms")
  print("metric:rtmin: "..rtmin.."ms")
  print("metric:rtmax: "..rtmax.."ms")
  return status
end

-- usage
function usage() 
  print("Usage: check_ping [-vh -p packets -t timeout] -H host")
  os.exit(0)
end

-- parse arguments
local long_opts = {
   help    = "h",
   host    = "H",
   packets = "p",
   timeout  = "t"
}

local opts,optind = getopts(arg, "hH:p:t:", long_opts)
opts["p"] = opts["t"] or "4"
opts["t"] = opts["t"] or "8"
if opts["h"] then
  usage()
end
if not opts["H"] then
  print("UNKNOWN - miss argument = 'host'\n")
  usage()
end

status=check(opts)

os.exit(status)

